{{ define "main" }}
<!-- Reading Progress Bar -->
<div id="reading-progress" class="fixed top-0 left-0 w-full h-1 bg-gray-200 dark:bg-gray-700 z-50">
    <div id="reading-progress-bar" class="h-full bg-gradient-to-r from-green-500 to-green-600 transition-all duration-150 ease-out" style="width: 0%"></div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="lg:grid lg:grid-cols-12 lg:gap-8">

        <!-- Table of Contents Sidebar -->
        <aside class="hidden lg:block lg:col-span-3">
            <div class="sticky top-20 space-y-4">
                <!-- Back to guides -->
                <a href="/guides/" class="inline-flex items-center text-sm text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors mb-4">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Tous les guides
                </a>

                <!-- TOC Box -->
                <nav id="toc-nav" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4" aria-label="Table des matières">
                    <h2 class="text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wide mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        Sommaire
                    </h2>
                    <ul id="toc-list" class="space-y-1 text-sm max-h-[60vh] overflow-y-auto">
                        <!-- TOC items will be generated by JavaScript -->
                    </ul>
                </nav>

                <!-- Reading stats -->
                <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center justify-between mb-1">
                        <span>Progression</span>
                        <span id="reading-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                        <div id="toc-progress-bar" class="bg-green-600 h-1.5 rounded-full transition-all duration-150" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <article class="lg:col-span-9">
            <!-- Mobile TOC Toggle -->
            <div class="lg:hidden mb-6">
                <button id="mobile-toc-toggle" class="w-full flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 text-sm font-medium text-gray-700 dark:text-gray-300">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        Sommaire
                    </span>
                    <svg id="mobile-toc-icon" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <nav id="mobile-toc" class="hidden mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                    <ul id="mobile-toc-list" class="space-y-2 text-sm max-h-[50vh] overflow-y-auto">
                        <!-- Mobile TOC items will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>

            <header class="mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4">{{ .Title }}</h1>
                {{ if .Description }}
                <p class="text-lg text-gray-600 dark:text-gray-400">{{ .Description }}</p>
                {{ end }}

                <!-- Meta info -->
                <div class="flex flex-wrap items-center gap-4 mt-4 text-sm text-gray-500 dark:text-gray-400">
                    {{ $wordCount := .WordCount }}
                    {{ $readingTime := div $wordCount 200 }}
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {{ $readingTime }} min de lecture
                    </span>
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        {{ $wordCount }} mots
                    </span>
                </div>
            </header>

            <!-- Content -->
            <div id="guide-content" class="prose-content guide-content">
                {{ .Content }}
            </div>

            <!-- Navigation between guides -->
            <nav class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700" aria-label="Navigation entre les guides">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {{ $currentIndex := -1 }}
                    {{ $guides := where .Site.RegularPages "Section" "guides" }}
                    {{ $guides = sort $guides ".Params.weight" }}
                    {{ range $index, $guide := $guides }}
                        {{ if eq $guide.Permalink $.Permalink }}
                            {{ $currentIndex = $index }}
                        {{ end }}
                    {{ end }}

                    <!-- Previous guide -->
                    {{ if gt $currentIndex 0 }}
                        {{ $prevGuide := index $guides (sub $currentIndex 1) }}
                        <a href="{{ $prevGuide.RelPermalink }}" class="group flex items-center p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-green-500 dark:hover:border-green-500 hover:shadow-md transition-all">
                            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 group-hover:bg-green-100 dark:group-hover:bg-green-900/30 transition-colors">
                                <svg class="w-5 h-5 text-gray-500 group-hover:text-green-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </div>
                            <div class="ml-3 text-left">
                                <span class="block text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Précédent</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors">{{ $prevGuide.Title }}</span>
                            </div>
                        </a>
                    {{ else }}
                        <div></div>
                    {{ end }}

                    <!-- Next guide -->
                    {{ $lastIndex := sub (len $guides) 1 }}
                    {{ if lt $currentIndex $lastIndex }}
                        {{ $nextGuide := index $guides (add $currentIndex 1) }}
                        <a href="{{ $nextGuide.RelPermalink }}" class="group flex items-center justify-end p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-green-500 dark:hover:border-green-500 hover:shadow-md transition-all sm:text-right">
                            <div class="mr-3 text-right">
                                <span class="block text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Suivant</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors">{{ $nextGuide.Title }}</span>
                            </div>
                            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 group-hover:bg-green-100 dark:group-hover:bg-green-900/30 transition-colors">
                                <svg class="w-5 h-5 text-gray-500 group-hover:text-green-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </a>
                    {{ end }}
                </div>
            </nav>

            <!-- Back to top button -->
            <div class="mt-8 text-center">
                <button id="back-to-top" class="inline-flex items-center px-4 py-2 text-sm text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    Retour en haut
                </button>
            </div>
        </article>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate TOC from headings
    const content = document.getElementById('guide-content');
    const tocList = document.getElementById('toc-list');
    const mobileTocList = document.getElementById('mobile-toc-list');
    const headings = content.querySelectorAll('h2, h3');

    headings.forEach((heading, index) => {
        // Create ID for the heading if it doesn't have one
        if (!heading.id) {
            heading.id = 'section-' + index;
        }

        const isH3 = heading.tagName === 'H3';
        const li = document.createElement('li');
        li.className = isH3 ? 'ml-3' : '';

        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.className = 'toc-link block py-1.5 px-2 rounded-md text-gray-600 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all ' + (isH3 ? 'text-xs' : 'text-sm font-medium');
        a.textContent = heading.textContent;
        a.setAttribute('data-target', heading.id);

        li.appendChild(a);
        tocList.appendChild(li.cloneNode(true));
        mobileTocList.appendChild(li);
    });

    // Smooth scroll for TOC links
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) {
                const offset = 80;
                const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
                // Close mobile TOC
                document.getElementById('mobile-toc').classList.add('hidden');
                document.getElementById('mobile-toc-icon').classList.remove('rotate-180');
            }
        });
    });

    // Reading progress and active section highlighting
    function updateProgress() {
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = Math.min((scrollTop / docHeight) * 100, 100);

        document.getElementById('reading-progress-bar').style.width = progress + '%';
        document.getElementById('toc-progress-bar').style.width = progress + '%';
        document.getElementById('reading-percent').textContent = Math.round(progress) + '%';

        // Update active section in TOC
        let currentSection = null;
        headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                currentSection = heading.id;
            }
        });

        document.querySelectorAll('.toc-link').forEach(link => {
            if (link.getAttribute('data-target') === currentSection) {
                link.classList.add('bg-green-100', 'dark:bg-green-900/30', 'text-green-700', 'dark:text-green-400');
                link.classList.remove('text-gray-600', 'dark:text-gray-400');
            } else {
                link.classList.remove('bg-green-100', 'dark:bg-green-900/30', 'text-green-700', 'dark:text-green-400');
                link.classList.add('text-gray-600', 'dark:text-gray-400');
            }
        });
    }

    window.addEventListener('scroll', updateProgress);
    updateProgress();

    // Mobile TOC toggle
    const mobileTocToggle = document.getElementById('mobile-toc-toggle');
    const mobileToc = document.getElementById('mobile-toc');
    const mobileTocIcon = document.getElementById('mobile-toc-icon');

    mobileTocToggle.addEventListener('click', function() {
        mobileToc.classList.toggle('hidden');
        mobileTocIcon.classList.toggle('rotate-180');
    });

    // Back to top
    document.getElementById('back-to-top').addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
});
</script>
{{ end }}
